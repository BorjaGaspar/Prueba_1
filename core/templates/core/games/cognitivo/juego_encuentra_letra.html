{% extends 'core/layouts/base_private.html' %}

{% block content %}
<div class="container-fluid py-2 d-flex flex-column" style="height: 92vh; max-height: 95vh;"> 
    
    <div class="d-flex justify-content-between align-items-center mb-1 px-3" style="max-width: 1200px; margin: 0 auto; width: 100%;">
        <div>
            <h4 class="fw-bold mb-0">Encuentra el Intruso</h4>
            <p class="text-muted mb-0 small">Nivel: <span id="display-nivel" class="fw-bold text-primary">{{ nivel_inicial }}</span></p>
        </div>
        
        <div class="d-flex gap-3 text-end">
            <div>
                <span class="text-muted small">Tiempo</span>
                <div class="fw-bold text-primary h5 mb-0" id="timer">0.0s</div>
            </div>
            <div>
                <span class="text-muted small">Puntos</span>
                <div class="fw-bold text-success h5 mb-0" id="score">0</div>
                <small class="d-block" style="line-height: 1;">Ronda: <span id="ronda">1</span>/5</small>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mx-auto d-flex justify-content-center align-items-center flex-grow-1" style="width: 100%; max-width: 1300px; background-color: #fff;"> 
        <div class="card-body p-1 text-center w-100 h-100 d-flex flex-column justify-content-center">
            
            <h5 class="mb-2" id="instruccion">Busca: <span class="badge bg-warning text-dark letra-objetivo fs-4" id="target-letter">?</span></h5>
            
            <div id="game-grid" class="game-grid">
                </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalFinJuego" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="modal-header border-0 justify-content-center">
                <h2 class="modal-title fw-bold">¬°Sesi√≥n Completada!</h2>
            </div>
            <div class="modal-body">
                <div id="medalla-icon" class="display-1 mb-3">üèÖ</div>
                <h3 id="mensaje-final">¬°Buen trabajo!</h3>
                <p class="lead">Puntuaci√≥n Final: <strong id="puntos-finales">0</strong></p>
                <p class="text-muted small">Tiempo total: <span id="tiempo-final-display"></span> segundos</p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <a href="{% url 'juegos' %}" class="btn btn-primary rounded-pill px-4">Volver al Men√∫</a>
                <button onclick="location.reload()" class="btn btn-outline-secondary rounded-pill px-4">Jugar otra vez</button>
            </div>
        </div>
    </div>
</div>

<style>
    .game-grid {
        display: grid;
        /* GAP M√çNIMO: 2px para que est√©n casi pegadas (Crowding Effect) */
        gap: 2px; 
        justify-content: center;
        margin: 0 auto;
        align-content: center;
    }
    
    .letter-box {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 3px; /* Bordes m√°s rectos para aprovechar espacio */
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        
        /* TAMA√ëO INTELIGENTE: */
        /* Reducimos ligeramente el multiplicador vh (de 6.5 a 5.8) para que quepan las 11 filas */
        width: clamp(22px, 5.8vh, 55px);
        height: clamp(22px, 5.8vh, 55px);
        
        /* Fuente grande y clara */
        font-size: clamp(0.9rem, 3.2vh, 2rem);
        font-weight: bold;
        color: #212529;
        
        transition: transform 0.1s;
        user-select: none;
    }

    /* Efecto Hover sutil */
    .letter-box:hover {
        background-color: #e9ecef;
        transform: scale(1.15);
        z-index: 100;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        border-color: #adb5bd;
    }

    .correct-click {
        background-color: #d1e7dd !important; 
        border-color: #198754 !important;
        color: #0f5132;
        transform: scale(1.1);
        z-index: 101;
    }
    
    .wrong-click {
        background-color: #f8d7da !important; 
        border-color: #dc3545 !important;
        animation: shake 0.4s;
        z-index: 101;
    }

    @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-4px); }
        50% { transform: translateX(4px); }
        75% { transform: translateX(-4px); }
        100% { transform: translateX(0); }
    }
</style>

<script>
    // --- 1. MOTOR DE FAMILIAS VISUALES ---
    const FAMILIAS = {
        CURVAS: ['O', 'C', 'G', 'Q', 'D', 'U'],
        RECTAS: ['E', 'F', 'H', 'I', 'L', 'T'],
        DIAGONALES: ['A', 'V', 'M', 'W', 'N', 'Z', 'X', 'K'],
        ROTACIONES: ['b', 'd', 'p', 'q'], 
        NUMEROS: ['3', '5', '6', '8', '9', '2'] 
    };

    let ultimoIntruso = null;

    // --- 2. CONFIGURACI√ìN DE NIVELES (M√ÅS FILAS, M√ÅS DENSIDAD) ---
    const NIVELES_CONFIG = {
        // Nivel 1: 4x3 (12 letras) - Tutorial rectangular
        1: { cols: 4, rows: 3, timeBonus: 200, generar: () => getParejaDiferente() },  
        
        // Nivel 2: 6x5 (30 letras) - +1 fila
        2: { cols: 6, rows: 5, timeBonus: 60, generar: () => getParejaDiferente() },  
        
        // Nivel 3: 9x6 (54 letras) - +1 fila
        3: { cols: 9, rows: 6, timeBonus: 45, generar: () => getParejaMismaFamilia(['RECTAS', 'CURVAS']) }, 
        
        // Nivel 4: 12x8 (96 letras) - +1 fila
        4: { cols: 12, rows: 8, timeBonus: 30, generar: () => getParejaMismaFamilia(['ROTACIONES', 'DIAGONALES']) }, 
        
        // Nivel 5: 16x11 (176 letras) - +1 fila. M√ÅXIMA DENSIDAD.
        5: { 
            cols: 16, 
            rows: 11, 
            timeBonus: 20, 
            generar: () => getParejaEspecifica(
                ['Q', 'O'], ['E', 'F'], ['M', 'N'], ['P', 'R'], 
                ['6', '9'], ['3', '8'], ['5', 'S']  
            ) 
        }  
    };

    let nivelUsuario = {{ nivel_inicial }}; 
    let rondaActual = 1;
    let maxRondas = 5;
    let puntosTotales = 0;
    
    let startTime;
    let timerInterval; 
    let clickHabilitado = true;
    let tiempoTotalAcumulado = 0; 

    const gridEl = document.getElementById('game-grid');
    const scoreEl = document.getElementById('score');
    const rondaEl = document.getElementById('ronda');
    const targetEl = document.getElementById('target-letter');
    const timerEl = document.getElementById('timer'); 

    // --- GENERADORES ---
    function getParejaDiferente() {
        const keys = ['CURVAS', 'RECTAS', 'DIAGONALES']; 
        let fam1, fam2, intruso, fondo, intentos = 0;
        do {
            const k1 = keys[Math.floor(Math.random() * keys.length)];
            let k2 = keys[Math.floor(Math.random() * keys.length)];
            while (k1 === k2) k2 = keys[Math.floor(Math.random() * keys.length)];
            fam1 = FAMILIAS[k1]; fam2 = FAMILIAS[k2];
            intruso = fam1[Math.floor(Math.random() * fam1.length)];
            fondo = fam2[Math.floor(Math.random() * fam2.length)];
            intentos++;
        } while (intruso === ultimoIntruso && intentos < 20);
        ultimoIntruso = intruso;
        return { intruso, fondo };
    }

    function getParejaMismaFamilia(tipos) {
        let intruso, fondo, intentos = 0;
        do {
            const tipo = tipos[Math.floor(Math.random() * tipos.length)];
            const familia = FAMILIAS[tipo];
            intruso = familia[Math.floor(Math.random() * familia.length)];
            fondo = familia[Math.floor(Math.random() * familia.length)];
            while (intruso === fondo) fondo = familia[Math.floor(Math.random() * familia.length)];
            intentos++;
        } while (intruso === ultimoIntruso && intentos < 20);
        ultimoIntruso = intruso;
        return { intruso, fondo };
    }

    function getParejaEspecifica(...pares) {
        const disponibles = pares.filter(p => p[0] !== ultimoIntruso);
        const pool = disponibles.length > 0 ? disponibles : pares;
        const par = pool[Math.floor(Math.random() * pool.length)];
        ultimoIntruso = par[0];
        return { intruso: par[0], fondo: par[1] };
    }

    function actualizarCronometro() {
        let tiempoActual = (Date.now() - startTime) / 1000;
        timerEl.innerText = tiempoActual.toFixed(1) + 's';
    }

    // --- L√ìGICA DEL JUEGO ---
    function iniciarRonda() {
        if (rondaActual > maxRondas) {
            finalizarJuego();
            return;
        }

        clearInterval(timerInterval);
        timerEl.innerText = "0.0s";
        clickHabilitado = true;
        rondaEl.innerText = rondaActual;
        
        const config = NIVELES_CONFIG[nivelUsuario] || NIVELES_CONFIG[5];
        const { intruso, fondo } = config.generar();
        targetEl.innerText = intruso; 

        gridEl.style.gridTemplateColumns = `repeat(${config.cols}, 1fr)`;
        
        const totalCeldas = config.cols * config.rows;
        const posIntruso = Math.floor(Math.random() * totalCeldas);
        
        gridEl.innerHTML = ''; 

        for (let i = 0; i < totalCeldas; i++) {
            let letra = (i === posIntruso) ? intruso : fondo;
            let esTarget = (i === posIntruso);
            let btn = document.createElement('div');
            btn.className = 'letter-box';
            btn.innerText = letra;
            btn.onclick = () => procesarClic(btn, esTarget, config.timeBonus);
            gridEl.appendChild(btn);
        }

        startTime = Date.now();
        timerInterval = setInterval(actualizarCronometro, 100);
    }

    function procesarClic(elemento, esCorrecto, tiempoMaximo) {
        if (!clickHabilitado) return;

        if (esCorrecto) {
            clearInterval(timerInterval);
            clickHabilitado = false;
            elemento.classList.add('correct-click');
            
            let tiempoUsado = (Date.now() - startTime) / 1000; 
            tiempoTotalAcumulado += tiempoUsado;

            timerEl.innerText = tiempoUsado.toFixed(1) + 's';

            let puntosRonda = 100; 
            let bonus = 0;
            if (tiempoUsado <= (tiempoMaximo / 2)) {
                bonus = 100; 
            } else if (tiempoUsado < tiempoMaximo) {
                bonus = 200 * (1 - (tiempoUsado / tiempoMaximo));
            }
            
            puntosRonda += Math.floor(Math.max(0, bonus));
            puntosTotales += puntosRonda;
            scoreEl.innerText = puntosTotales;

            setTimeout(() => {
                rondaActual++;
                iniciarRonda();
            }, 1000);

        } else {
            elemento.classList.add('wrong-click');
            puntosTotales = Math.max(0, puntosTotales - 10);
            scoreEl.innerText = puntosTotales;
        }
    }

    function finalizarJuego() {
        clearInterval(timerInterval);
        const modal = new bootstrap.Modal(document.getElementById('modalFinJuego'));
        document.getElementById('puntos-finales').innerText = puntosTotales;
        
        const displayTiempo = document.getElementById('tiempo-final-display');
        if(displayTiempo) displayTiempo.innerText = Math.round(tiempoTotalAcumulado);

        const medallaIcon = document.getElementById('medalla-icon');
        const mensaje = document.getElementById('mensaje-final');
        
        if (puntosTotales >= 800) {
            medallaIcon.innerText = 'ü•á'; 
            mensaje.innerText = "¬°Incre√≠ble! Nivel Oro";
            mensaje.className = "text-warning";
        } else if (puntosTotales >= 400) {
            medallaIcon.innerText = 'ü•à'; 
            mensaje.innerText = "¬°Muy bien! Nivel Plata";
            mensaje.className = "text-secondary";
        } else {
            medallaIcon.innerText = 'ü•â'; 
            mensaje.innerText = "¬°Bien hecho! Sigue as√≠";
            mensaje.className = "text-danger";
        }
        
        modal.show();
        guardarSesion(puntosTotales);
    }

    function guardarSesion(puntos) {
        const datos = {
            juego: "Encuentra la Letra",
            nivel: nivelUsuario,
            puntos: puntos,
            tiempo: Math.round(tiempoTotalAcumulado),
            completado: true
        };

        fetch('/api/guardar-progreso/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(datos)
        })
        .then(response => {
            if (response.ok) console.log("¬°Guardado con √©xito!");
            else console.error("Error al guardar");
        });
    }

    document.addEventListener('DOMContentLoaded', iniciarRonda);

</script>
{% endblock %}