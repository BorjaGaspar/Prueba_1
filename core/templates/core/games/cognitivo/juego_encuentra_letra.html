{% extends 'core/layouts/base_private.html' %}
{% load static %} {% block content %}
<div class="container-fluid py-2 d-flex flex-column" style="height: 92vh; max-height: 95vh;"> 
    
    <div id="pantalla-instrucciones" class="card shadow-lg border-0 mx-auto w-100 my-auto" style="max-width: 800px; border-radius: 20px;">
        <div class="card-body p-5 text-center">
            
            <button id="btn-leer-instrucciones" class="btn btn-primary rounded-circle mb-4 shadow" style="width: 80px; height: 80px; transition: transform 0.2s;">
                <i class="bi bi-volume-up-fill" style="font-size: 2.5rem;"></i>
            </button>

            <h2 class="fw-bold mb-4 display-6 text-dark">¬øC√≥mo se juega?</h2>
            
            <div id="texto-instrucciones" class="fs-4 text-muted mb-5 px-3" style="line-height: 1.6;">
                En la siguiente pantalla aparecer√°n muchas letras iguales.<br><br>
                Tu objetivo es encontrar la <strong>√öNICA letra que es diferente</strong> a las dem√°s y tocarla lo m√°s r√°pido posible.
            </div>

            <div class="d-flex flex-column flex-md-row justify-content-center gap-3">
                <button class="btn btn-light btn-lg px-4 py-3 rounded-pill border shadow-sm fw-bold text-secondary" data-bs-toggle="modal" data-bs-target="#modalVideoAyuda">
                    <i class="bi bi-camera-video me-2 fs-5"></i> No lo entiendo muy bien
                </button>
                <button class="btn btn-success btn-lg px-5 py-3 rounded-pill shadow fw-bold text-white" onclick="comenzarJuego()" style="font-size: 1.2rem;">
                    <i class="bi bi-play-fill me-2 fs-4"></i> ¬°Empezar a Jugar!
                </button>
            </div>

        </div>
    </div>

    <div id="pantalla-juego" style="display: none; height: 100%; flex-direction: column;">
        <div class="d-flex justify-content-between align-items-center mb-1 px-3" style="max-width: 1200px; margin: 0 auto; width: 100%;">
            <div>
                <h4 class="fw-bold mb-0">Encuentra el Intruso</h4>
                <p class="text-muted mb-0 small">Nivel: <span id="display-nivel" class="fw-bold text-primary">{{ nivel_inicial }}</span></p>
            </div>
            
            <div class="d-flex gap-3 text-end">
                <div>
                    <span class="text-muted small">Tiempo</span>
                    <div class="fw-bold text-primary h5 mb-0" id="timer">0.0s</div>
                </div>
                <div>
                    <span class="text-muted small">Puntos</span>
                    <div class="fw-bold text-success h5 mb-0" id="score">0</div>
                    <small class="d-block" style="line-height: 1;">Ronda: <span id="ronda">1</span>/5</small>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 mx-auto d-flex justify-content-center align-items-center flex-grow-1" style="width: 100%; max-width: 1300px; background-color: #fff;"> 
            <div class="card-body p-1 text-center w-100 h-100 d-flex flex-column justify-content-center">
                
                <h5 class="mb-2" id="instruccion">Busca: <span class="badge bg-warning text-dark letra-objetivo fs-4" id="target-letter">?</span></h5>
                
                <div id="game-grid" class="game-grid">
                    </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVideoAyuda" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header border-0 bg-light rounded-top-4 p-4">
                <h4 class="modal-title fw-bold text-dark"><i class="bi bi-info-circle-fill text-primary me-2"></i> Explicaci√≥n Detallada</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <p class="fs-5 text-muted mb-4">Aqu√≠ tienes un v√≠deo de ejemplo de c√≥mo funciona el ejercicio.</p>
                
                <div class="mb-4 mx-auto overflow-hidden shadow-sm" style="max-width: 600px; border-radius: 12px; border: 2px solid #e9ecef;">
                    <video id="video-tutorial" width="100%" controls class="d-block" preload="metadata">
                        <source src="{% static 'core/videos/tutorial_letras.mp4' %}" type="video/mp4">
                        Tu navegador no soporta la reproducci√≥n de v√≠deos.
                    </video>
                </div>

                <button type="button" class="btn btn-primary btn-lg rounded-pill px-5 fw-bold" data-bs-dismiss="modal">
                    ¬°Entendido, vamos a jugar!
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFinJuego" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4 rounded-4 border-0 shadow-lg">
            <div class="modal-header border-0 justify-content-center">
                <h2 class="modal-title fw-bold">¬°Sesi√≥n Completada!</h2>
            </div>
            <div class="modal-body">
                <div id="medalla-icon" class="display-1 mb-3">üèÖ</div>
                <h3 id="mensaje-final">¬°Buen trabajo!</h3>
                <p class="lead">Puntuaci√≥n Final: <strong id="puntos-finales">0</strong></p>
                <p class="text-muted small">Tiempo total: <span id="tiempo-final-display"></span> segundos</p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <a href="{% url 'juegos' %}" class="btn btn-light rounded-pill px-4 border fw-bold">Volver al Men√∫</a>
                <button onclick="location.reload()" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm">Jugar otra vez</button>
            </div>
        </div>
    </div>
</div>

<style>
    .game-grid {
        display: grid;
        gap: 2px; 
        justify-content: center;
        margin: 0 auto;
        align-content: center;
    }
    
    .letter-box {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 3px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: clamp(22px, 5.8vh, 55px);
        height: clamp(22px, 5.8vh, 55px);
        font-size: clamp(0.9rem, 3.2vh, 2rem);
        font-weight: bold;
        color: #212529;
        transition: transform 0.1s;
        user-select: none;
    }

    .letter-box:hover {
        background-color: #e9ecef;
        transform: scale(1.15);
        z-index: 100;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        border-color: #adb5bd;
    }

    .correct-click {
        background-color: #d1e7dd !important; 
        border-color: #198754 !important;
        color: #0f5132;
        transform: scale(1.1);
        z-index: 101;
    }
    
    .wrong-click {
        background-color: #f8d7da !important; 
        border-color: #dc3545 !important;
        animation: shake 0.4s;
        z-index: 101;
    }

    @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-4px); }
        50% { transform: translateX(4px); }
        75% { transform: translateX(-4px); }
        100% { transform: translateX(0); }
    }

    #btn-leer-instrucciones:active {
        transform: scale(0.9);
    }
</style>

<script>
    // --- L√ìGICA DEL ALTAVOZ (TEXT-TO-SPEECH) ---
    document.getElementById('btn-leer-instrucciones').addEventListener('click', function() {
        window.speechSynthesis.cancel(); 
        
        const texto = "En la siguiente pantalla aparecer√°n muchas letras iguales. Tu objetivo es encontrar la √öNICA letra que es diferente a las dem√°s, y tocarla lo m√°s r√°pido posible.";
        
        const utterance = new SpeechSynthesisUtterance(texto);
        utterance.lang = 'es-ES'; 
        utterance.rate = 0.85;     
        utterance.pitch = 1;      
        
        window.speechSynthesis.speak(utterance);
    });

    // --- PAUSAR VIDEO AL CERRAR MODAL ---
    // Esto evita que el video siga sonando si el usuario cierra la ventana de ayuda
    const modalVideo = document.getElementById('modalVideoAyuda');
    modalVideo.addEventListener('hidden.bs.modal', function () {
        const video = document.getElementById('video-tutorial');
        if (video) {
            video.pause();
        }
    });

    // --- TRANSICI√ìN: DE INSTRUCCIONES A JUEGO ---
    function comenzarJuego() {
        window.speechSynthesis.cancel();
        
        // Pausar el video por si acaso lo dejaron reproduci√©ndose
        const video = document.getElementById('video-tutorial');
        if (video) video.pause();

        document.getElementById('pantalla-instrucciones').style.display = 'none';
        
        const pantallaJuego = document.getElementById('pantalla-juego');
        pantallaJuego.style.display = 'flex'; 
        
        iniciarRonda();
    }

    // --- 1. MOTOR DE FAMILIAS VISUALES ---
    const FAMILIAS = {
        CURVAS: ['O', 'C', 'G', 'Q', 'D', 'U'],
        RECTAS: ['E', 'F', 'H', 'I', 'L', 'T'],
        DIAGONALES: ['A', 'V', 'M', 'W', 'N', 'Z', 'X', 'K'],
        ROTACIONES: ['b', 'd', 'p', 'q'], 
        NUMEROS: ['3', '5', '6', '8', '9', '2'] 
    };

    let ultimoIntruso = null;

    // --- 2. CONFIGURACI√ìN DE NIVELES ---
    const NIVELES_CONFIG = {
        1: { cols: 4, rows: 3, timeBonus: 200, generar: () => getParejaDiferente() },  
        2: { cols: 6, rows: 5, timeBonus: 60, generar: () => getParejaDiferente() },  
        3: { cols: 9, rows: 6, timeBonus: 45, generar: () => getParejaMismaFamilia(['RECTAS', 'CURVAS']) }, 
        4: { cols: 12, rows: 8, timeBonus: 30, generar: () => getParejaMismaFamilia(['ROTACIONES', 'DIAGONALES']) }, 
        5: { cols: 16, rows: 11, timeBonus: 20, generar: () => getParejaEspecifica(['Q', 'O'], ['E', 'F'], ['M', 'N'], ['P', 'R'], ['6', '9'], ['3', '8'], ['5', 'S']) }  
    };

    let nivelUsuario = {{ nivel_inicial }}; 
    let rondaActual = 1;
    let maxRondas = 5;
    let puntosTotales = 0;
    
    let startTime;
    let timerInterval; 
    let clickHabilitado = true;
    let tiempoTotalAcumulado = 0; 

    const gridEl = document.getElementById('game-grid');
    const scoreEl = document.getElementById('score');
    const rondaEl = document.getElementById('ronda');
    const targetEl = document.getElementById('target-letter');
    const timerEl = document.getElementById('timer'); 

    function getParejaDiferente() {
        const keys = ['CURVAS', 'RECTAS', 'DIAGONALES']; 
        let fam1, fam2, intruso, fondo, intentos = 0;
        do {
            const k1 = keys[Math.floor(Math.random() * keys.length)];
            let k2 = keys[Math.floor(Math.random() * keys.length)];
            while (k1 === k2) k2 = keys[Math.floor(Math.random() * keys.length)];
            fam1 = FAMILIAS[k1]; fam2 = FAMILIAS[k2];
            intruso = fam1[Math.floor(Math.random() * fam1.length)];
            fondo = fam2[Math.floor(Math.random() * fam2.length)];
            intentos++;
        } while (intruso === ultimoIntruso && intentos < 20);
        ultimoIntruso = intruso;
        return { intruso, fondo };
    }

    function getParejaMismaFamilia(tipos) {
        let intruso, fondo, intentos = 0;
        do {
            const tipo = tipos[Math.floor(Math.random() * tipos.length)];
            const familia = FAMILIAS[tipo];
            intruso = familia[Math.floor(Math.random() * familia.length)];
            fondo = familia[Math.floor(Math.random() * familia.length)];
            while (intruso === fondo) fondo = familia[Math.floor(Math.random() * familia.length)];
            intentos++;
        } while (intruso === ultimoIntruso && intentos < 20);
        ultimoIntruso = intruso;
        return { intruso, fondo };
    }

    function getParejaEspecifica(...pares) {
        const disponibles = pares.filter(p => p[0] !== ultimoIntruso);
        const pool = disponibles.length > 0 ? disponibles : pares;
        const par = pool[Math.floor(Math.random() * pool.length)];
        ultimoIntruso = par[0];
        return { intruso: par[0], fondo: par[1] };
    }

    function actualizarCronometro() {
        let tiempoActual = (Date.now() - startTime) / 1000;
        timerEl.innerText = tiempoActual.toFixed(1) + 's';
    }

    function iniciarRonda() {
        if (rondaActual > maxRondas) {
            finalizarJuego();
            return;
        }

        clearInterval(timerInterval);
        timerEl.innerText = "0.0s";
        clickHabilitado = true;
        rondaEl.innerText = rondaActual;
        
        const config = NIVELES_CONFIG[nivelUsuario] || NIVELES_CONFIG[5];
        const { intruso, fondo } = config.generar();
        targetEl.innerText = intruso; 

        gridEl.style.gridTemplateColumns = `repeat(${config.cols}, 1fr)`;
        
        const totalCeldas = config.cols * config.rows;
        const posIntruso = Math.floor(Math.random() * totalCeldas);
        
        gridEl.innerHTML = ''; 

        for (let i = 0; i < totalCeldas; i++) {
            let letra = (i === posIntruso) ? intruso : fondo;
            let esTarget = (i === posIntruso);
            let btn = document.createElement('div');
            btn.className = 'letter-box';
            btn.innerText = letra;
            btn.onclick = () => procesarClic(btn, esTarget, config.timeBonus);
            gridEl.appendChild(btn);
        }

        startTime = Date.now();
        timerInterval = setInterval(actualizarCronometro, 100);
    }

    function procesarClic(elemento, esCorrecto, tiempoMaximo) {
        if (!clickHabilitado) return;

        if (esCorrecto) {
            clearInterval(timerInterval);
            clickHabilitado = false;
            elemento.classList.add('correct-click');
            
            let tiempoUsado = (Date.now() - startTime) / 1000; 
            tiempoTotalAcumulado += tiempoUsado;

            timerEl.innerText = tiempoUsado.toFixed(1) + 's';

            let puntosRonda = 100; 
            let bonus = 0;
            if (tiempoUsado <= (tiempoMaximo / 2)) {
                bonus = 100; 
            } else if (tiempoUsado < tiempoMaximo) {
                bonus = 200 * (1 - (tiempoUsado / tiempoMaximo));
            }
            
            puntosRonda += Math.floor(Math.max(0, bonus));
            puntosTotales += puntosRonda;
            scoreEl.innerText = puntosTotales;

            setTimeout(() => {
                rondaActual++;
                iniciarRonda();
            }, 1000);

        } else {
            elemento.classList.add('wrong-click');
            puntosTotales = Math.max(0, puntosTotales - 10);
            scoreEl.innerText = puntosTotales;
        }
    }

    function finalizarJuego() {
        clearInterval(timerInterval);
        const modal = new bootstrap.Modal(document.getElementById('modalFinJuego'));
        document.getElementById('puntos-finales').innerText = puntosTotales;
        
        const displayTiempo = document.getElementById('tiempo-final-display');
        if(displayTiempo) displayTiempo.innerText = Math.round(tiempoTotalAcumulado);

        const medallaIcon = document.getElementById('medalla-icon');
        const mensaje = document.getElementById('mensaje-final');
        
        if (puntosTotales >= 800) {
            medallaIcon.innerText = 'ü•á'; 
            mensaje.innerText = "¬°Incre√≠ble! Nivel Oro";
            mensaje.className = "text-warning";
        } else if (puntosTotales >= 400) {
            medallaIcon.innerText = 'ü•à'; 
            mensaje.innerText = "¬°Muy bien! Nivel Plata";
            mensaje.className = "text-secondary";
        } else {
            medallaIcon.innerText = 'ü•â'; 
            mensaje.innerText = "¬°Bien hecho! Sigue as√≠";
            mensaje.className = "text-danger";
        }
        
        modal.show();
        guardarSesion(puntosTotales);
    }

    function guardarSesion(puntos) {
        const datos = {
            juego: "Encuentra la Letra",
            nivel: nivelUsuario,
            puntos: puntos,
            tiempo: Math.round(tiempoTotalAcumulado),
            completado: true
        };

        fetch('/api/guardar-progreso/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(datos)
        })
        .then(response => {
            if (response.ok) console.log("¬°Guardado con √©xito!");
            else console.error("Error al guardar");
        });
    }

</script>
{% endblock %}