{% extends 'core/layouts/base_medico.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 bg-white p-4 rounded-4 shadow-sm border">
    <div class="d-flex align-items-center">
        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3 shadow-sm" style="width: 60px; height: 60px; font-size: 1.5rem;">
            {{ paciente.usuario.username|slice:":2"|upper }}
        </div>
        <div>
            <h3 class="fw-bold text-dark mb-0">An치lisis de Rendimiento</h3>
            <p class="text-muted mb-0">Paciente: <strong>{{ paciente.usuario.username }}</strong></p>
        </div>
    </div>
    
    <a href="{% url 'detalle_paciente' paciente.id %}" class="btn btn-outline-secondary rounded-pill px-4 fw-bold">
        <i class="bi bi-arrow-left me-2"></i> Volver al Perfil
    </a>
</div>

<div id="zona-selector">
    <h5 class="fw-bold mb-3 text-secondary">1. Selecciona un 츼rea Cognitiva</h5>
    
    <div class="row g-4 mb-4" id="fila-categorias">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 hover-elevate cursor-pointer" onclick="mostrarJuegos('Atenci칩n')">
                <div class="card-body p-4 text-center border-top border-5 border-warning rounded">
                    <i class="bi bi-eye-fill display-3 text-warning mb-3"></i>
                    <h5 class="fw-bold text-dark">Atenci칩n</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 hover-elevate cursor-pointer" onclick="mostrarJuegos('Lenguaje')">
                <div class="card-body p-4 text-center border-top border-5 border-success rounded">
                    <i class="bi bi-chat-quote-fill display-3 text-success mb-3"></i>
                    <h5 class="fw-bold text-dark">Lenguaje</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 hover-elevate cursor-pointer" onclick="mostrarJuegos('Motor')">
                <div class="card-body p-4 text-center border-top border-5 border-danger rounded">
                    <i class="bi bi-hand-index-thumb-fill display-3 text-danger mb-3"></i>
                    <h5 class="fw-bold text-dark">Motor</h5>
                </div>
            </div>
        </div>
    </div>

    <div id="contenedor-juegos" class="d-none animate__animated animate__fadeIn">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold text-secondary mb-0">2. Selecciona un Ejercicio de <span id="titulo-categoria" class="text-dark"></span></h5>
            <button class="btn btn-sm btn-light border" onclick="volverCategorias()"><i class="bi bi-arrow-up me-1"></i> Cambiar 츼rea</button>
        </div>

        <div id="juegos-Atenci칩n" class="row g-3 d-none lista-juegos">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm hover-elevate cursor-pointer bg-white" onclick="cargarAnalisis('Encuentra la Letra')">
                    <div class="card-body p-3 d-flex align-items-center">
                        <div class="bg-warning bg-opacity-10 p-3 rounded-3 me-3 text-warning"><i class="bi bi-search fs-4"></i></div>
                        <div><h6 class="fw-bold mb-0">Encuentra la Letra</h6><small class="text-muted">Atenci칩n Selectiva</small></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="juegos-Lenguaje" class="row g-3 d-none lista-juegos">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm hover-elevate cursor-pointer bg-white" onclick="cargarAnalisis('Juego 1: Memoria')">
                    <div class="card-body p-3 d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 p-3 rounded-3 me-3 text-success"><i class="bi bi-cpu-fill fs-4"></i></div>
                        <div><h6 class="fw-bold mb-0">Juego 1: Memoria</h6><small class="text-muted">Versi칩n Web</small></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm hover-elevate cursor-pointer bg-white" onclick="cargarAnalisis('Laboratorio Voz')">
                    <div class="card-body p-3 d-flex align-items-center">
                        <div class="bg-danger bg-opacity-10 p-3 rounded-3 me-3 text-danger"><i class="bi bi-mic-fill fs-4"></i></div>
                        <div><h6 class="fw-bold mb-0">Laboratorio Voz</h6><small class="text-muted">An치lisis Whisper</small></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="juegos-Motor" class="row g-3 d-none lista-juegos">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm hover-elevate cursor-pointer bg-white" onclick="cargarAnalisis('Prueba de C치mara')">
                    <div class="card-body p-3 d-flex align-items-center">
                        <div class="bg-danger bg-opacity-10 p-3 rounded-3 me-3 text-danger"><i class="bi bi-camera-video-fill fs-4"></i></div>
                        <div><h6 class="fw-bold mb-0">Prueba C치mara</h6><small class="text-muted">Control Gestual</small></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="zona-analisis" class="d-none animate__animated animate__zoomIn">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <span class="badge bg-primary mb-2">An치lisis de Ejercicio</span>
            <h2 class="fw-bold text-dark mb-0" id="titulo-graficas">Nombre del Juego</h2>
        </div>
        <button class="btn btn-dark rounded-pill px-4" onclick="cerrarAnalisis()">
            <i class="bi bi-x-lg me-2"></i> Cerrar An치lisis
        </button>
    </div>

    <div id="mensaje-sin-datos" class="alert alert-warning border-warning shadow-sm d-none rounded-4 p-4 text-center">
        <i class="bi bi-info-circle-fill display-4 text-warning mb-3 d-block"></i>
        <h5 class="fw-bold text-dark">No hay datos suficientes</h5>
        <p class="mb-0 text-muted">El paciente todav칤a no ha completado ninguna sesi칩n de este ejercicio.</p>
    </div>

    <div id="controles-nivel" class="d-none">
        
        <ul class="nav nav-pills mb-4 justify-content-center bg-white p-2 rounded-pill shadow-sm border" id="niveles-pills" style="max-width: 600px; margin: 0 auto;">
            </ul>

        <div class="row text-center mb-4 g-3">
            <div class="col-md-3">
                <div class="p-3 bg-white shadow-sm border rounded-4">
                    <h6 class="text-muted text-uppercase small fw-bold mb-1">Partidas Jugadas</h6>
                    <h3 id="stat-partidas" class="fw-bold text-dark mb-0">-</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-3 bg-white shadow-sm border rounded-4 border-top border-4 border-primary">
                    <h6 class="text-muted text-uppercase small fw-bold mb-1">Puntuaci칩n M치xima</h6>
                    <h3 id="stat-max-puntos" class="fw-bold text-primary mb-0">-</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-3 bg-white shadow-sm border rounded-4 border-top border-4 border-info">
                    <h6 class="text-muted text-uppercase small fw-bold mb-1">Tiempo Medio</h6>
                    <h3 id="stat-avg-tiempo" class="fw-bold text-info mb-0">-</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="p-3 bg-white shadow-sm border rounded-4 border-top border-4 border-warning">
                    <h6 class="text-muted text-uppercase small fw-bold mb-1">Estado General</h6>
                    <h3 id="stat-animo-emoji" class="mb-0">游눫</h3>
                </div>
            </div>
        </div>

        <h5 class="fw-bold text-secondary mb-3 mt-4"><i class="bi bi-bar-chart-steps me-2"></i>Rendimiento Objetivo</h5>
        <div id="contenedor-graficas-objetivas" class="row g-4 mb-4">
            
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100 rounded-4 d-flex flex-column">
                    <div class="card-header bg-white border-0 pt-4 pb-0 px-4">
                        <h6 class="fw-bold text-primary mb-0"><i class="bi bi-trophy-fill me-2"></i> Puntuaci칩n por Sesi칩n</h6>
                    </div>
                    <div class="card-body p-4 flex-grow-1">
                        <div style="height: 250px;"><canvas id="graficaPuntos"></canvas></div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100 rounded-4 d-flex flex-column">
                    <div class="card-header bg-white border-0 pt-4 pb-0 px-4">
                        <h6 class="fw-bold text-info mb-0"><i class="bi bi-stopwatch-fill me-2"></i> Tiempos de Reacci칩n</h6>
                    </div>
                    <div class="card-body p-4 flex-grow-1">
                        <div style="height: 250px;"><canvas id="graficaTiempos"></canvas></div>
                    </div>
                </div>
            </div>
            
        </div>

        <h5 class="fw-bold text-secondary mb-3 mt-4"><i class="bi bi-person-hearts me-2"></i>Autopercepci칩n del Paciente (PROMs)</h5>
        <div id="contenedor-graficas-subjetivas" class="row g-4 mb-5">
            
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100 rounded-4 d-flex flex-column border-start border-5 border-warning">
                    <div class="card-header bg-white border-0 pt-4 pb-0 px-4">
                        <h6 class="fw-bold text-warning mb-0"><i class="bi bi-speedometer2 me-2"></i> Dificultad Percibida</h6>
                    </div>
                    <div class="card-body p-4 flex-grow-1">
                        <div style="height: 250px;"><canvas id="graficaDificultad"></canvas></div>
                    </div>
                    <div class="card-footer bg-light border-0 rounded-bottom-4 p-3 text-muted small">
                        <i class="bi bi-info-circle me-1"></i> Si la dificultad baja mientras los puntos suben, indica adaptaci칩n cognitiva al ejercicio.
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100 rounded-4 d-flex flex-column border-start border-5 border-success">
                    <div class="card-header bg-white border-0 pt-4 pb-0 px-4">
                        <h6 class="fw-bold text-success mb-0"><i class="bi bi-emoji-smile-fill me-2"></i> Estado de 츼nimo</h6>
                    </div>
                    <div class="card-body p-4 flex-grow-1">
                        <div style="height: 250px;"><canvas id="graficaAnimo"></canvas></div>
                    </div>
                    <div class="card-footer bg-light border-0 rounded-bottom-4 p-3 text-muted small">
                        <i class="bi bi-info-circle me-1"></i> Detecta fluctuaciones an칤micas, frustraci칩n (burnout) o posible falta de motivaci칩n.
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<style>
    .cursor-pointer { cursor: pointer; }
    .hover-elevate { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .hover-elevate:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; }
    .nav-pills .nav-link { font-weight: bold; border-radius: 50rem; transition: all 0.2s; }
    .nav-pills .nav-link.disabled { opacity: 0.5; background-color: #f8f9fa !important; border-color: transparent !important; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const baseDatosJuegos = JSON.parse('{{ datos_juegos_json|escapejs }}');
    
    let chartPuntos = null;
    let chartTiempos = null;
    let chartDificultad = null;
    let chartAnimo = null;
    let juegoActivo = "";

    function interpretarAnimo(valorMedia) {
        if(valorMedia === 0) return { emoji: "游눫" };
        if(valorMedia <= 1.5) return { emoji: "游땩" };
        if(valorMedia <= 2.5) return { emoji: "游뗴" };
        if(valorMedia <= 3.5) return { emoji: "游땛" };
        if(valorMedia <= 4.5) return { emoji: "游뗵" };
        return { emoji: "游땏" };
    }

    function mostrarJuegos(categoria) {
        document.getElementById('contenedor-juegos').classList.remove('d-none');
        document.getElementById('titulo-categoria').innerText = categoria;
        document.querySelectorAll('.lista-juegos').forEach(el => el.classList.add('d-none'));
        const listaActiva = document.getElementById('juegos-' + categoria);
        if(listaActiva) listaActiva.classList.remove('d-none');
    }

    function volverCategorias() {
        document.getElementById('contenedor-juegos').classList.add('d-none');
        document.querySelectorAll('.lista-juegos').forEach(el => el.classList.add('d-none'));
    }

    function cerrarAnalisis() {
        document.getElementById('zona-analisis').classList.add('d-none');
        document.getElementById('zona-selector').classList.remove('d-none');
    }

    function cargarAnalisis(nombreJuego) {
        document.getElementById('zona-selector').classList.add('d-none');
        document.getElementById('zona-analisis').classList.remove('d-none');
        document.getElementById('titulo-graficas').innerText = nombreJuego;
        juegoActivo = nombreJuego;

        const sinDatosDiv = document.getElementById('mensaje-sin-datos');
        const controlesDiv = document.getElementById('controles-nivel');

        if (!baseDatosJuegos[nombreJuego] || Object.keys(baseDatosJuegos[nombreJuego]).length === 0) {
            sinDatosDiv.classList.remove('d-none');
            controlesDiv.classList.add('d-none');
            return;
        }

        sinDatosDiv.classList.add('d-none');
        controlesDiv.classList.remove('d-none');

        const navPills = document.getElementById('niveles-pills');
        navPills.innerHTML = '';
        let nivelASeleccionar = null;

        for (let i = 1; i <= 5; i++) {
            const nivelStr = i.toString();
            const tieneDatos = baseDatosJuegos[nombreJuego].hasOwnProperty(nivelStr);
            if (tieneDatos && !nivelASeleccionar) nivelASeleccionar = nivelStr; 

            const activeClass = tieneDatos ? 'border border-primary text-primary cursor-pointer' : 'disabled border text-muted';
            navPills.innerHTML += `
                <li class="nav-item flex-fill text-center px-1" role="presentation">
                    <button class="nav-link w-100 ${activeClass}" id="pill-btn-${nivelStr}" 
                            onclick="if(${tieneDatos}) cargarNivel('${nivelStr}')" type="button">
                        Nivel ${i}
                    </button>
                </li>
            `;
        }

        if (nivelASeleccionar) cargarNivel(nivelASeleccionar);
    }

    function cargarNivel(nivel) {
        for(let i=1; i<=5; i++) {
            let btn = document.getElementById('pill-btn-' + i);
            if(btn && !btn.classList.contains('disabled')) {
                btn.classList.remove('active', 'bg-primary', 'text-white');
                btn.classList.add('text-primary');
            }
        }
        let btnActivo = document.getElementById('pill-btn-' + nivel);
        if(btnActivo) {
            btnActivo.classList.remove('text-primary');
            btnActivo.classList.add('active', 'bg-primary', 'text-white');
        }

        const datos = baseDatosJuegos[juegoActivo][nivel];
        const numPartidas = datos.puntos.length;
        const maxPuntos = Math.max(...datos.puntos);
        const sumaTiempos = datos.tiempos.reduce((a, b) => a + b, 0);
        const avgTiempo = numPartidas > 0 ? (sumaTiempos / numPartidas).toFixed(1) : 0;

        const aniValidas = datos.animos.filter(a => a > 0);
        const avgAni = aniValidas.length > 0 ? aniValidas.reduce((a, b) => a + b, 0) / aniValidas.length : 0;

        document.getElementById('stat-partidas').innerText = numPartidas;
        document.getElementById('stat-max-puntos').innerText = maxPuntos + ' pts';
        document.getElementById('stat-avg-tiempo').innerText = avgTiempo + 's';
        document.getElementById('stat-animo-emoji').innerText = interpretarAnimo(avgAni).emoji;

        dibujarGraficas(datos.fechas, datos.puntos, datos.tiempos, datos.dificultades, datos.animos);
    }

    function dibujarGraficas(fechas, puntos, tiempos, dificultades, animos) {
        // Destruir gr치ficas viejas
        if (chartPuntos) chartPuntos.destroy();
        if (chartTiempos) chartTiempos.destroy();
        if (chartDificultad) chartDificultad.destroy();
        if (chartAnimo) chartAnimo.destroy();

        // 1. Gr치ficas Objetivas
        const ctxPuntos = document.getElementById('graficaPuntos').getContext('2d');
        chartPuntos = new Chart(ctxPuntos, {
            type: 'line',
            data: {
                labels: fechas,
                datasets: [{
                    label: 'Puntuaci칩n',
                    data: puntos,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderWidth: 3, tension: 0.3, fill: true,
                    pointBackgroundColor: '#fff', pointBorderColor: '#0d6efd', pointRadius: 6
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { borderDash: [5, 5] } }, x: { grid: { display: false } } } }
        });

        const ctxTiempos = document.getElementById('graficaTiempos').getContext('2d');
        chartTiempos = new Chart(ctxTiempos, {
            type: 'bar',
            data: {
                labels: fechas,
                datasets: [{
                    label: 'Tiempo',
                    data: tiempos,
                    backgroundColor: 'rgba(13, 202, 240, 0.7)',
                    borderColor: '#0dcaf0',
                    borderWidth: 2, borderRadius: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { borderDash: [5, 5] } }, x: { grid: { display: false } } } }
        });

        // 2. Gr치ficas Subjetivas (PROMs)
        // Convertimos los ceros (partidas antiguas sin datos) a 'null' para que la l칤nea se corte y no baje a cero
        const difDataLimpiada = dificultades.map(d => d === 0 ? null : d);
        const aniDataLimpiada = animos.map(a => a === 0 ? null : a);

        const ctxDificultad = document.getElementById('graficaDificultad').getContext('2d');
        chartDificultad = new Chart(ctxDificultad, {
            type: 'line',
            data: {
                labels: fechas,
                datasets: [{
                    label: 'Dificultad',
                    data: difDataLimpiada,
                    borderColor: '#ffc107', // Warning color
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderWidth: 3, tension: 0.1, fill: true,
                    spanGaps: true, // Conecta los puntos ignorando los nulls
                    pointBackgroundColor: '#fff', pointBorderColor: '#ffc107', pointRadius: 6
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false } },
                    y: {
                        min: 0.5, max: 5.5, // Para dar un poco de aire arriba y abajo
                        ticks: {
                            stepSize: 1,
                            callback: function(value) {
                                if (value === 1) return '1 - Muy F치cil';
                                if (value === 2) return '2 - F치cil';
                                if (value === 3) return '3 - Normal';
                                if (value === 4) return '4 - Dif칤cil';
                                if (value === 5) return '5 - Muy Dif칤cil';
                                return '';
                            }
                        }
                    }
                }
            }
        });

        const ctxAnimo = document.getElementById('graficaAnimo').getContext('2d');
        chartAnimo = new Chart(ctxAnimo, {
            type: 'line',
            data: {
                labels: fechas,
                datasets: [{
                    label: '츼nimo',
                    data: aniDataLimpiada,
                    borderColor: '#198754', // Success color
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    borderWidth: 3, tension: 0.1, fill: true,
                    spanGaps: true,
                    pointBackgroundColor: '#fff', pointBorderColor: '#198754', pointRadius: 6
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false } },
                    y: {
                        min: 0.5, max: 5.5,
                        ticks: {
                            stepSize: 1,
                            font: { size: 16 }, // Emojis m치s grandes
                            callback: function(value) {
                                if (value === 1) return '1 游땩';
                                if (value === 2) return '2 游뗴';
                                if (value === 3) return '3 游땛';
                                if (value === 4) return '4 游뗵';
                                if (value === 5) return '5 游땏';
                                return '';
                            }
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}